import tkinter as tk
from tkinter import ttk, messagebox
import threading
import os
import requests
import subprocess
import ctypes
import string

# --- Логика (Backend) ---

def is_admin():
    """Проверка прав администратора"""
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False

def download_iso(progress_bar, progress_label):
    """Функция загрузки ISO с индикацией прогресса"""
    # Ссылка на Internet Archive (Windows 10 22H2 Russian x64)
    url = "https://dn710004.ca.archive.org/0/items/windows-10-22-h-2-russian-x-64/Windows%2010%2022H2%20%28Russian%29%20x64.iso"
    save_path = os.path.join(os.path.expanduser("~"), "Desktop", "Windows.iso")

    def run():
        try:
            # Запрос с потоковой передачей данных
            response = requests.get(url, stream=True, allow_redirects=True, timeout=60)
            response.raise_for_status()
            
            total_size = response.headers.get('content-length')
            
            if total_size:
                total_size = int(total_size)
                root.after(0, lambda: progress_bar.configure(mode="determinate", maximum=100))
            else:
                # Если сервер не отдал размер, включаем "бегающий" индикатор
                root.after(0, lambda: progress_bar.configure(mode="indeterminate"))
                root.after(0, progress_bar.start)

            downloaded = 0
            with open(save_path, "wb") as f:
                for chunk in response.iter_content(chunk_size=1024*1024): # Качаем по 1 МБ
                    if chunk:
                        f.write(chunk)
                        downloaded += len(chunk)
                        
                        if total_size:
                            percent = int((downloaded / total_size) * 100)
                            root.after(0, lambda p=percent: update_progress(p, progress_bar, progress_label))
                        else:
                            mb = downloaded // (1024*1024)
                            root.after(0, lambda m=mb: progress_label.config(text=f"Скачано: {m} МБ (размер неизвестен)"))
            
            if not total_size:
                root.after(0, progress_bar.stop)
            
            root.after(0, lambda: progress_label.config(text="Статус: Загрузка завершена!"))
            root.after(0, lambda: messagebox.showinfo("Готово", f"ISO успешно сохранен на рабочий стол!\nПуть: {save_path}"))
            
        except Exception as e:
            root.after(0, lambda: messagebox.showerror("Ошибка", f"Не удалось скачать: {e}"))

    # Запускаем в отдельном потоке, чтобы GUI не зависал
    threading.Thread(target=run, daemon=True).start()

def update_progress(percent, progress_bar, progress_label):
    progress_bar['value'] = percent
    progress_label.config(text=f"Прогресс: {percent}%")

def mount_iso():
    """Монтирование образа через PowerShell"""
    iso_path = os.path.join(os.path.expanduser("~"), "Desktop", "Windows.iso")
    if os.path.exists(iso_path):
        try:
            subprocess.run(["powershell", "-Command", f'Mount-DiskImage -ImagePath "{iso_path}"'], shell=True, check=True)
            messagebox.showinfo("Успех", "Образ примонтирован как виртуальный диск!")
        except Exception as e:
            messagebox.showerror("Ошибка", f"Не удалось примонтировать: {e}")
    else:
        messagebox.showerror("Ошибка", "Файл Windows.iso не найден на рабочем столе!")

def start_upgrade():
    """Поиск и запуск setup.exe на всех дисках"""
    found = False
    for letter in string.ascii_uppercase:
        setup_path = f"{letter}:\\setup.exe"
        if os.path.exists(setup_path):
            try:
                subprocess.Popen(setup_path, shell=True)
                found = True
                break
            except:
                continue
    
    if not found:
        messagebox.showerror("Ошибка", "setup.exe не найден. Убедитесь, что ISO примонтирован.")

def check_space():
    """Проверка свободного места на диске C:"""
    import shutil
    total, used, free = shutil.disk_usage("C:")
    free_gb = free // (2**30)
    messagebox.showinfo("Диск C:", f"Свободно: {free_gb} ГБ.\nДля обновления рекомендуется > 20 ГБ.")

# --- Интерфейс (GUI) ---

root = tk.Tk()
root.title("win10updateTool")
root.geometry("550x600")
root.configure(bg="#f0f0f0")

# Стили для кнопок
style = ttk.Style()
style.configure("TButton", font=("Segoe UI", 10), padding=5)

frame = tk.Frame(root, bg="#f0f0f0")
frame.pack(pady=20, padx=20, fill="both", expand=True)

tk.Label(frame, text="Win10 Update Tool", font=("Segoe UI", 18, "bold"), bg="#f0f0f0", fg="#333").pack(pady=10)

# Индикатор
progress_bar = ttk.Progressbar(frame, orient="horizontal", length=400, mode="determinate")
progress_bar.pack(pady=10)

progress_label = tk.Label(frame, text="Статус: Ожидание", font=("Segoe UI", 10), bg="#f0f0f0")
progress_label.pack(pady=5)

# Кнопки
ttk.Button(frame, text="1. Скачать ISO (Win10 x64)", command=lambda: download_iso(progress_bar, progress_label)).pack(pady=5, fill="x")
ttk.Button(frame, text="2. Монтировать образ (Win 8/10)", command=mount_iso).pack(pady=5, fill="x")
ttk.Button(frame, text="3. Запустить обновление", command=start_upgrade).pack(pady=5, fill="x")
ttk.Button(frame, text="Проверить место на диске", command=check_space).pack(pady=5, fill="x")

# Инфо
info_text = (
    "Инструкция для Windows 7:\n"
    "1. Скачайте ISO.\n"
    "2. Откройте его через 7-Zip или WinRAR.\n"
    "3. Запустите setup.exe вручную."
)
tk.Label(frame, text=info_text, font=("Segoe UI", 9), bg="#f0f0f0", justify="left", fg="#666").pack(pady=20)

# Статус админа
admin_status = "ЕСТЬ" if is_admin() else "НЕТ (запустите от имени администратора!)"
color = "green" if is_admin() else "red"
tk.Label(frame, text=f"Права администратора: {admin_status}", font=("Segoe UI", 9, "bold"), bg="#f0f0f0", fg=color).pack(side="bottom", pady=10)

root.mainloop()

